<ng-template let-folders="folders" #folderTree>
    <ul class="folder-list">
        @for (folder of folders; track folder.id) {
            <li class="folder-item">

                <div class="folder-item-info" 
                     [style.--folder-depth]="folder.depth"
                     [class.active]="folder.id === activeFolderId"
                     [class.has-children]="folder.origin.subFolderCount > 0"
                     (click)="navToFolder(folder, $event)">

                    <!-- 苹果风细线箭头 -->
                    @if(folder.origin.subFolderCount) {
                        <button class="btn-toggle" [class.active]="folder.expanded" (click)="toggleFolder(folder, $event)">
                            @if (folder.loading) {
                                <svg class="icon-arrow loading" width="12" height="12" viewBox="0 0 12 12" fill="none">
                                    <circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="1.5" stroke-dasharray="8 4" fill="none"/>
                                </svg>
                            } @else {
                                <svg class="icon-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none">
                                    <path d="M4 3l4 3-4 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            }
                        </button>
                    } @else {
                        <span class="btn-toggle-placeholder"></span>
                    }

                    <!-- 彩色拟态图标 -->
                    <div class="folder-icon-wrapper">
                        @if (!folder.origin.subFolderCount && !folder.origin.subCount) {
                            <!-- 空文件夹 - 淡灰蓝 -->
                            <svg class="icon-folder empty" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M3 5C3 4.44772 3.44772 4 4 4H7.5L9 6H16C16.5523 6 17 6.44772 17 7V15C17 15.5523 16.5523 16 16 16H4C3.44772 16 3 15.5523 3 15V5Z" fill="url(#emptyGradient)" stroke="url(#emptyGradientStroke)" stroke-width="1.2"/>
                                <path d="M3 5H9L7.5 7H3V5Z" fill="url(#emptyGradientLight)"/>
                                <defs>
                                    <linearGradient id="emptyGradient" x1="3" y1="4" x2="17" y2="16">
                                        <stop offset="0%" stop-color="#cbd5e1" stop-opacity="0.6"/>
                                        <stop offset="100%" stop-color="#94a3b8" stop-opacity="0.8"/>
                                    </linearGradient>
                                    <linearGradient id="emptyGradientStroke" x1="3" y1="4" x2="17" y2="16">
                                        <stop offset="0%" stop-color="#94a3b8"/>
                                        <stop offset="100%" stop-color="#64748b"/>
                                    </linearGradient>
                                    <linearGradient id="emptyGradientLight" x1="3" y1="5" x2="9" y2="7">
                                        <stop offset="0%" stop-color="#f1f5f9" stop-opacity="0.4"/>
                                        <stop offset="100%" stop-color="#e2e8f0" stop-opacity="0.2"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        } @else if (folder.origin.subFolderCount > 0) {
                            <!-- 有子文件夹 - 蓝绿渐变 -->
                            <svg class="icon-folder has-children" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M3 5C3 4.44772 3.44772 4 4 4H7.5L9 6H16C16.5523 6 17 6.44772 17 7V15C17 15.5523 16.5523 16 16 16H4C3.44772 16 3 15.5523 3 15V5Z" fill="url(#folderGradient)" stroke="url(#folderGradientStroke)" stroke-width="1.2"/>
                                <path d="M3 5H9L7.5 7H3V5Z" fill="url(#folderGradientLight)"/>
                                <circle cx="15" cy="7" r="3" fill="#f59e0b" opacity="0.9">
                                    <animate attributeName="opacity" values="0.9;0.6;0.9" dur="2s" repeatCount="indefinite"/>
                                </circle>
                                <defs>
                                    <linearGradient id="folderGradient" x1="3" y1="4" x2="17" y2="16">
                                        <stop offset="0%" stop-color="#10b981" stop-opacity="0.9"/>
                                        <stop offset="50%" stop-color="#14b8a6" stop-opacity="0.85"/>
                                        <stop offset="100%" stop-color="#06b6d4" stop-opacity="0.8"/>
                                    </linearGradient>
                                    <linearGradient id="folderGradientStroke" x1="3" y1="4" x2="17" y2="16">
                                        <stop offset="0%" stop-color="#059669"/>
                                        <stop offset="100%" stop-color="#0891b2"/>
                                    </linearGradient>
                                    <linearGradient id="folderGradientLight" x1="3" y1="5" x2="9" y2="7">
                                        <stop offset="0%" stop-color="#ffffff" stop-opacity="0.5"/>
                                        <stop offset="100%" stop-color="#ffffff" stop-opacity="0.2"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        } @else {
                            <!-- 普通文件夹 - 蓝绿系 -->
                            <svg class="icon-folder" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M3 5C3 4.44772 3.44772 4 4 4H7.5L9 6H16C16.5523 6 17 6.44772 17 7V15C17 15.5523 16.5523 16 16 16H4C3.44772 16 3 15.5523 3 15V5Z" fill="url(#normalFolderGradient)" stroke="url(#normalFolderGradientStroke)" stroke-width="1.2"/>
                                <path d="M3 5H9L7.5 7H3V5Z" fill="url(#normalFolderGradientLight)"/>
                                <defs>
                                    <linearGradient id="normalFolderGradient" x1="3" y1="4" x2="17" y2="16">
                                        <stop offset="0%" stop-color="#10b981" stop-opacity="0.85"/>
                                        <stop offset="100%" stop-color="#14b8a6" stop-opacity="0.75"/>
                                    </linearGradient>
                                    <linearGradient id="normalFolderGradientStroke" x1="3" y1="4" x2="17" y2="16">
                                        <stop offset="0%" stop-color="#059669"/>
                                        <stop offset="100%" stop-color="#0d9488"/>
                                    </linearGradient>
                                    <linearGradient id="normalFolderGradientLight" x1="3" y1="5" x2="9" y2="7">
                                        <stop offset="0%" stop-color="#ffffff" stop-opacity="0.4"/>
                                        <stop offset="100%" stop-color="#ffffff" stop-opacity="0.15"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        }
                    </div>

                    <div class="folder-item-name">
                        <span class="folder-item-name-text">{{ folder.origin.name }}</span>
                        
                        <!-- 状态徽章 -->
                        <div class="folder-status-badges">
                            @if (folder.origin.localUser?.behavior?.favorite) {
                                <span class="status-badge favorite" title="已收藏">
                                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                                        <path d="M6 1.5l1.5 3 3.5.5-2.5 2.5.5 3.5L6 9.5 3 10.5l.5-3.5L1 4.5l3.5-.5L6 1.5z" fill="currentColor"/>
                                    </svg>
                                </span>
                            }
                            @if (folder.origin.shared) {
                                <span class="status-badge shared" title="已共享">
                                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                                        <path d="M6 1L1 3v4l5 2 5-2V3L6 1z" stroke="currentColor" stroke-width="1.2" fill="none"/>
                                        <circle cx="6" cy="6" r="1.5" fill="currentColor"/>
                                    </svg>
                                </span>
                            }
                            @if (folder.origin.locked) {
                                <span class="status-badge locked" title="已锁定">
                                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                                        <rect x="3" y="5" width="6" height="5" rx="1" fill="currentColor"/>
                                        <path d="M4 5V3a2 2 0 012-2h0a2 2 0 012 2v2" stroke="currentColor" stroke-width="1.2" fill="none"/>
                                    </svg>
                                </span>
                            }
                            @if (folder.origin.isNew) {
                                <span class="status-badge new" title="最近新增">
                                    <span class="status-dot"></span>
                                </span>
                            }
                        </div>
                    </div>
                </div>

                @if (folder.children && folder.expanded) {
                    <ng-container *ngTemplateOutlet="folderTree; context: {folders: folder.children}"></ng-container>
                }
            </li>
        }
    </ul>
</ng-template>

<ng-container *ngTemplateOutlet="folderTree; context: {folders: folderList}"></ng-container>
